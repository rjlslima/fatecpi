<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroneGuard - Gestão de Combate a Incêndios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d5d3f',
                        secondary: '#2d9c6a',
                        danger: '#e53e3e',
                        warning: '#dd6b20',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        .login-bg {
            background: url('https://images.unsplash.com/photo-1523309994053-aca3bc0a2304?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80') no-repeat center center;
            background-size: cover;
        }
        .map-container, .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .aspect-video {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
        }
        .aspect-video iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .active-menu {
            position: relative;
            background-color: #f0fdf4;
            color: #0d5d3f;
        }
        .active-menu:after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: #0d5d3f;
        }
        .google-maps-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        @keyframes droneMove {
            0% { transform: translate(0, 0); }
            25% { transform: translate(5px, 5px); }
            50% { transform: translate(10px, 0); }
            75% { transform: translate(5px, -5px); }
            100% { transform: translate(0, 0); }
        }
        .drone-marker {
            animation: droneMove 8s infinite linear;
            position: absolute;
            z-index: 10;
        }
        .temperature-overlay {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-weight: 600;
            z-index: 20;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
    <div id="loginScreen" class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden">
        <div class="login-bg h-48 flex items-end p-6">
            <div class="bg-black/40 p-4 rounded-lg backdrop-blur-sm w-full">
                <h1 class="text-3xl font-bold text-white text-center">
                    <i class="fas fa-fire mr-2 text-red-500"></i>DroneGuard
                </h1>
                <p class="text-center text-white/90 mt-1">Gestão de Drones para Combate a Incêndios</p>
            </div>
        </div>
        <form id="loginForm" class="p-8">
            <div class="mb-6">
                <label for="username" class="block text-gray-700 font-medium mb-2">Usuário - fatec</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-user text-gray-400"> </i>
                    </div>
                    <input type="text" id="username"
                        class="w-full pl-10 pr-3 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-secondary"
                        placeholder="Digite seu usuário" required>
                </div>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 font-medium mb-2">Senha - fatec</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-400"></i>
                    </div>
                    <input type="password" id="password"
                        class="w-full pl-10 pr-3 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-secondary"
                        placeholder="Digite sua senha - fatec" required>
                </div>
            </div>
            <button type="submit"
                class="w-full bg-primary hover:bg-secondary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300">
                Entrar <i class="fas fa-sign-in-alt ml-2"></i>
            </button>
        </form>
        <div class="bg-gray-100 p-4 text-center text-sm text-gray-600">
            <p>© 2025 DroneGuard System. Todos os direitos reservados.</p>
        </div>
    </div>

    <div id="mainApp" class="w-full h-screen bg-gray-50 overflow-hidden hidden">
        <div class="w-full bg-white shadow-sm flex items-center justify-between p-4">
             <div class="flex items-center">
                 <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                     <i class="fas fa-fire text-white text-xl"></i>
                 </div>
                 <div class="ml-3">
                     <h1 class="text-xl font-bold text-gray-800">DroneGuard</h1>
                     <p class="text-xs text-gray-500">Sistema de Gestão de Combate a Incêndios</p>
                 </div>
             </div>
             <div class="flex items-center space-x-4">
                 <div class="relative">
                     <button class="p-2 text-gray-600 hover:text-secondary"><i class="fas fa-bell text-xl"></i></button>
                     <span class="absolute top-0 right-0 w-3 h-3 bg-danger rounded-full"></span>
                 </div>
                 <div class="flex items-center">
                     <div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-600"></i></div>
                     <div class="ml-3">
                         <p class="text-sm font-medium text-gray-800" id="currentUsername">Administrador</p>
                         <button id="logoutBtn" class="text-xs text-danger font-medium hover:underline">Sair</button>
                     </div>
                 </div>
             </div>
        </div>
        <div class="flex h-[calc(100vh-73px)]">
            <div class="w-64 bg-white shadow-lg p-4 flex flex-col">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-2 border-b pb-2">Legendas</h2>
                    <ul class="text-sm text-gray-700 space-y-2 mt-2">
                        <li><strong class="text-primary">VTNT:</strong> Veículo de Terra Não Tripulado</li>
                        <li><strong class="text-primary">DARFP:</strong> Drone a Retardante de Fogo a Pó</li>
                    </ul>
                </div>
                <nav class="flex-grow">
                    <ul>
                        <li><a href="#" data-view="dashboard" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 active-menu"><i class="fas fa-home mr-3 text-secondary w-5 text-center"></i><span>Dashboard</span></a></li>
                        <li><a href="#" data-view="realTime" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100"><i class="fas fa-map-marked-alt mr-3 text-secondary w-5 text-center"></i><span>Monitoramento</span></a></li>
                        <li><a href="#" data-view="towerCamera" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100"><i class="fas fa-video mr-3 text-secondary w-5 text-center"></i><span>Câmera de Torre</span></a></li>
                        <li><a href="#" data-view="history" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100"><i class="fas fa-calendar-day mr-3 text-secondary w-5 text-center"></i><span>Histórico</span></a></li>
                        <li id="adminPanelLink" class="hidden"><a href="#" data-view="adminPanel" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100"><i class="fas fa-users-cog mr-3 text-secondary w-5 text-center"></i><span>Painel Admin</span></a></li>
                    </ul>
                </nav>
            </div>
            <div class="flex-1 overflow-auto p-6">
                <div id="dashboard">
                     <h1 class="text-2xl font-bold text-gray-800 mb-6">Visão Geral</h1>
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                         <div class="bg-white rounded-xl shadow p-5 flex items-center"><div class="p-3 bg-green-100 rounded-lg"><i class="fas fa-fire text-danger text-2xl"></i></div><div class="ml-4"><p class="text-gray-500">Incêndios Ativos</p><h3 class="text-2xl font-bold">2</h3></div></div>
                         <div class="bg-white rounded-xl shadow p-5 flex items-center"><div class="p-3 bg-green-100 rounded-lg"><i class="fas fa-fire-extinguisher text-primary text-2xl"></i></div><div class="ml-4"><p class="text-gray-500">Drones Disponíveis</p><h3 class="text-2xl font-bold">7/7</h3></div></div>
                         <div class="bg-white rounded-xl shadow p-5 flex items-center"><div class="p-3 bg-green-100 rounded-lg"><i class="fas fa-temperature-high text-warning text-2xl"></i></div><div class="ml-4"><p class="text-gray-500">Temperatura Média</p><h3 class="text-2xl font-bold">32°C</h3></div></div>
                         <div class="bg-white rounded-xl shadow p-5 flex items-center"><div class="p-3 bg-green-100 rounded-lg"><i class="fas fa-tachometer-alt text-secondary text-2xl"></i></div><div class="ml-4"><p class="text-gray-500">Resposta Média</p><h3 class="text-2xl font-bold">5.2 min</h3></div></div>
                         <div class="bg-white rounded-xl shadow p-5 flex items-center">
                            <div class="p-3 bg-blue-100 rounded-lg"><i class="fas fa-wind text-blue-500 text-2xl"></i></div>
                            <div class="ml-4">
                                <p class="text-gray-500">Velocidade do Vento</p>
                                <h3 class="text-2xl font-bold" id="windSpeed">-- km/h</h3>
                            </div>
                         </div>
                         <div class="bg-white rounded-xl shadow p-5 flex items-center">
                            <div class="p-3 bg-gray-200 rounded-lg"><i class="fas fa-compass text-gray-700 text-2xl"></i></div>
                            <div class="ml-4">
                                <p class="text-gray-500">Direção do Vento</p>
                                <h3 class="text-2xl font-bold" id="windDirection">--</h3>
                            </div>
                         </div>
                     </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                         <div class="bg-white rounded-xl shadow p-5"><h2 class="text-lg font-semibold mb-4">Atividade Recente</h2><div class="space-y-4"><div class="flex items-center border-b pb-3"><div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center"><i class="fas fa-play text-green-600"></i></div><div class="ml-3"><p class="font-medium">Drone VTNT-03 iniciou combate</p><p class="text-sm text-gray-500">2 minutos atrás</p></div></div><div class="flex items-center border-b pb-3"><div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"><i class="fas fa-map-marked-alt text-blue-600"></i></div><div class="ml-3"><p class="font-medium">Área de risco identificada</p><p class="text-sm text-gray-500">15 minutos atrás</p></div></div><div class="flex items-center"><div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center"><i class="fas fa-sync-alt text-purple-600"></i></div><div class="ml-3"><p class="font-medium">Drone DARFP-02 recarregado</p><p class="text-sm text-gray-500">30 minutos atrás</p></div></div></div></div>
                         <div class="bg-white rounded-xl shadow p-5"><h2 class="text-lg font-semibold mb-4">Áreas de Risco</h2><div class="h-64 rounded-lg overflow-hidden"><div class="map-container rounded-lg" id="riskAreaMap"><iframe class="google-maps-iframe" src=""></iframe></div></div></div>
                     </div>
                </div>
                <div id="realTime" class="hidden h-full">
                     <div class="flex flex-col h-full gap-6">
                         <div class="flex-shrink-0 h-1/4 bg-white shadow-lg rounded-xl p-4 overflow-y-auto">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Frota de Combate</h2>
                            <div class="space-y-2" id="droneListContainer"></div>
                        </div>
                         <div class="flex-grow h-3/4 relative rounded-xl overflow-hidden shadow-lg">
                             <div class="map-container" id="realTimeMap">
                                 <iframe class="google-maps-iframe" src=""></iframe>
                                 <div class="temperature-overlay">
                                     <i class="fas fa-thermometer-half mr-2"></i>Temperatura: <span id="currentTemperature">--</span>°C
                                 </div>
                             </div>
                         </div>
                     </div>
                </div>
                <div id="towerCamera" class="hidden">
                    <div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold text-gray-800">Câmeras de Torre</h1><button id="configureVideosBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition hidden"><i class="fas fa-cog mr-2"></i>Configurar Vídeos</button></div>
                    <div id="towerVideosContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow p-4"><h2 class="text-lg font-semibold mb-4">Visão Normal</h2><div id="normalVideoContainer" class="aspect-video bg-black rounded-lg flex items-center justify-center text-white"></div></div>
                        <div class="bg-white rounded-xl shadow p-4"><h2 class="text-lg font-semibold mb-4">Visão Térmica</h2><div id="thermalVideoContainer" class="aspect-video bg-black rounded-lg flex items-center justify-center text-white"></div></div>
                    </div>
                </div>
                <div id="history" class="hidden">
                    <div class="text-center mb-6"><h1 class="text-2xl font-bold text-gray-800">Histórico de Incidentes</h1><p class="text-gray-500">Clique em uma data para ver os detalhes.</p></div>
                    <div class="bg-white rounded-xl shadow p-4"><div id="historyDatesList" class="flex flex-wrap justify-center gap-4"></div></div>
                </div>
                <div id="adminPanel" class="hidden">
                     <h1 class="text-2xl font-bold text-gray-800 mb-6">Painel Administrativo</h1>
                    <div class="bg-white rounded-xl shadow overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b"><button id="addUserBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition"><i class="fas fa-plus mr-2"></i>Adicionar Usuário</button></div>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nível de Acesso</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th></tr></thead><tbody class="bg-white divide-y divide-gray-200" id="usersTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg w-full max-w-md">
            <div class="p-4 border-b flex justify-between items-center"><h3 class="text-lg font-semibold" id="modalTitle"></h3><button id="cancelModal" class="text-gray-500 hover:text-gray-800 text-2xl">×</button></div>
            <div class="p-4"><form id="userForm"><input type="hidden" id="userId"><div class="mb-4"><label class="block text-gray-700 mb-2">Usuário</label><input type="text" id="usernameInput" class="w-full px-4 py-2 border rounded-lg" required></div><div class="mb-4"><label class="block text-gray-700 mb-2">Senha</label><input type="password" id="passwordInput" class="w-full px-4 py-2 border rounded-lg" required></div><div class="mb-4"><label class="block text-gray-700 mb-2">Nível de Acesso</label><select id="roleInput" class="w-full px-4 py-2 border rounded-lg" required><option value="master">Master</option><option value="admin">Administrador</option><option value="viewer">Visualizador</option></select></div></form></div>
            <div class="p-4 border-t flex justify-end"><button id="saveUser" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary">Salvar</button></div>
        </div>
    </div>
    <div id="configureVideosModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
         <div class="bg-white rounded-lg w-full max-w-md">
             <div class="p-4 border-b flex justify-between items-center"><h3 class="text-lg font-semibold">Configurar Vídeos da Torre</h3><button id="cancelConfigureVideos" class="text-gray-500 hover:text-gray-800 text-2xl">×</button></div>
             <div class="p-4 space-y-4">
                 <div><label for="normalVideoUrl" class="block font-medium mb-1">URL do Vídeo Normal (YouTube)</label><input type="text" id="normalVideoUrl" placeholder="https://www.youtube.com/watch?v=VIDEO_ID" class="w-full px-3 py-2 border rounded-lg"></div>
                 <div><label for="thermalVideoUrl" class="block font-medium mb-1">URL do Vídeo Térmico (YouTube)</label><input type="text" id="thermalVideoUrl" placeholder="https://www.youtube.com/watch?v=VIDEO_ID" class="w-full px-3 py-2 border rounded-lg"></div>
             </div>
             <div class="p-4 border-t flex justify-end"><button id="saveConfiguredVideos" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary">Salvar</button></div>
         </div>
    </div>
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white"><h3 class="text-lg font-semibold" id="historyModalTitle"></h3><button id="closeHistoryModal" class="text-gray-500 hover:text-gray-800 text-2xl">×</button></div>
            <div class="p-6" id="historyModalContent"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let users = [ { id: 1, username: 'admin', role: 'master', password: 'admin' }, { id: 2, username: 'gerente', role: 'admin', password: 'gerente123' }, { id: 3, username: 'fatec', role: 'viewer', password: 'fatec' }];
            
            let drones = [
                { id: 1, name: "Drone Gerencial", icon: "fas fa-cogs", iconColor: "text-gray-700", battery: "98%", autonomy: "2h", status: "online", position: { left: "45%", top: "40%" }, maintenanceIn: '45 dias' }, 
                { id: 2, name: "DARFP-03", icon: "fa-fire-extinguisher", iconColor: "text-green-500", battery: "100%", autonomy: "1h", status: "online", capacity: "75L/100L", position: { left: "50%", top: "45%" }, maintenanceIn: '28 dias' }, 
                { id: 3, name: "VTNT-01", icon: "fa-truck", iconColor: "text-blue-500", battery: "100%", autonomy: "2h", status: "online", capacity: "950L/1000L", position: { left: "40%", top: "50%" }, maintenanceIn: '60 dias' }, 
                { id: 4, name: "VTNT-02", icon: "fa-truck", iconColor: "text-blue-500", battery: "85%", autonomy: "1:30h", status: "online", capacity: "830L/1000L", position: { left: "55%", top: "50%" }, maintenanceIn: '15 dias' }, 
                { id: 5, name: "DARFP-01", icon: "fa-fire-extinguisher", iconColor: "text-green-500", battery: "100%", autonomy: "1h", status: "stand-by", capacity: "100L/100L", position: { left: "40%", top: "40%" }, maintenanceIn: '30 dias' }, 
                { id: 6, name: "DARFP-02", icon: "fa-fire-extinguisher", iconColor: "text-green-500", battery: "100%", autonomy: "1h", status: "stand-by", capacity: "100L/100L", position: { left: "40%", top: "40%" }, maintenanceIn: '30 dias' }, 
                { id: 7, name: "VTNT-03", icon: "fa-truck", iconColor: "text-blue-500", battery: "100%", autonomy: "1:30h", status: "stand-by", capacity: "1000L/1000L", position: { left: "20%", top: "20%" }, maintenanceIn: '10 dias' }
            ];
            
            // INÍCIO DA MODIFICAÇÃO: 4 novos itens adicionados ao histórico
            let historyEvents = {
                '28/05/2024': { events: [{ type: "fire", location: "Setor D5", responseTime: "11 min", dronesInvolved: "VTNT-02, DARFP-01", resourcesUsed: "80l, 350l Água", duration: "30 min" }], summary: "Pequeno foco de incêndio em vegetação seca, controlado rapidamente." },
                '15/04/2024': { events: [{ type: "safe", report: "Manutenção programada no VTNT-01 concluída." }, { type: "safe", report: "Nenhum alerta de temperatura elevada durante o dia." }], summary: "Dia tranquilo, com atividades de manutenção preventiva." },
                '02/03/2024': { events: [{ type: "fire", location: "Próximo à Torre 3", responseTime: "9 min", dronesInvolved: "DARFP-03", resourcesUsed: "40l", duration: "15 min" }, { type: "safe", report: "Sistema de câmeras térmicas verificado e calibrado." }], summary: "Um incidente menor controlado e verificação de sistemas." },
                '20/01/2024': { events: [{ type: "safe", report: "Monitoramento de rotina sem ocorrências." }], summary: "Dia sem incidentes." },
                '15/10/2023': { events: [{ type: "safe", report: "Dia sem incidentes." }, { type: "safe", report: "Manutenção preventiva realizada." }], summary: "Dia sem incidentes. Manutenção preventiva concluída." },
                '12/10/2023': { events: [{ type: "fire", location: "Setor A2", responseTime: "8 min", dronesInvolved: "DARFP-02, VTNT-05", resourcesUsed: "75l, 250l Água", duration: "25 min" }], summary: "1 foco de incêndio detectado e controlado." },
                '05/09/2023': { events: [{ type: "fire", location: "Setor C3", responseTime: "15 min", dronesInvolved: "DARFP-01, VTNT-03", resourcesUsed: "90l, 600l Água", duration: "45 min" }], summary: "1 foco de incêndio de média intensidade. Controlado com sucesso." }
            };
            // FIM DA MODIFICAÇÃO
            
            let towerVideos = {
                normalVideo: "https://youtu.be/_qCtfHbt40U",
                thermalVideo: "https://youtu.be/J8rutOUi-FM"
            };
            
            const fixedCoords = "-20.839381,-48.328954";
            
            const mainApp = document.getElementById('mainApp');
            const contentSections = document.querySelectorAll('.flex-1 > div[id]');
            const configureVideosModal = document.getElementById('configureVideosModal');
            const historyModal = document.getElementById('historyModal');
            const userModal = document.getElementById('userModal');
            const currentTemperatureSpan = document.getElementById('currentTemperature');
            const windSpeedSpan = document.getElementById('windSpeed');
            const windDirectionSpan = document.getElementById('windDirection');

            function showView(viewName) {
                contentSections.forEach(section => section.classList.add('hidden'));
                const activeSection = document.getElementById(viewName);
                if (activeSection) {
                    activeSection.classList.remove('hidden');
                    if(viewName === 'realTime') { renderDronesList(); renderDroneMarkers(); } 
                    else if (viewName === 'adminPanel') { renderUsersTable(); } 
                    else if (viewName === 'history') { renderHistoryDates(); }
                    else if (viewName === 'towerCamera') {
                        renderVideo('normalVideoContainer', convertYoutubeUrlToEmbed(towerVideos.normalVideo));
                        renderVideo('thermalVideoContainer', convertYoutubeUrlToEmbed(towerVideos.thermalVideo));
                    }
                }
            }

            document.querySelectorAll('[data-view]').forEach(view => {
                view.addEventListener('click', function (e) {
                    e.preventDefault();
                    const viewName = this.getAttribute('data-view');
                    showView(viewName);
                    document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active-menu'));
                    this.classList.add('active-menu');
                });
            });

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const user = users.find(u => u.username === document.getElementById('username').value && u.password === document.getElementById('password').value);
                if (user) {
                    document.getElementById('currentUsername').textContent = user.username;
                    const isAdmin = user.role === 'master' || user.role === 'admin';
                    document.getElementById('adminPanelLink').classList.toggle('hidden', !isAdmin);
                    document.getElementById('configureVideosBtn').classList.toggle('hidden', !isAdmin);
                    document.getElementById('loginScreen').classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    initializeMaps();
                    showView('dashboard');
                } else { alert('Credenciais inválidas.'); }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                mainApp.classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
            });

            function initializeMaps() {
                const mapUrl = `https://maps.google.com/maps?q=${fixedCoords}&t=k&z=17&ie=UTF8&iwloc=&output=embed`;
                document.querySelector('#riskAreaMap iframe').src = mapUrl;
                document.querySelector('#realTimeMap iframe').src = mapUrl;
            }
            
            // INÍCIO DA MODIFICAÇÃO: Boxes da lista de drones mais compactos
            function renderDronesList() {
                const container = document.getElementById('droneListContainer');
                container.innerHTML = drones.map(drone => `
                    <div class="bg-gray-50 rounded-xl p-2 border border-gray-200">
                        <div class="flex items-start">
                            <div class="w-16 h-16 rounded-lg bg-gray-200 flex items-center justify-center mr-3">
                                <i class="fas ${drone.icon} text-2xl ${drone.iconColor}"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-semibold">${drone.name}</h3>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">${drone.status}</span>
                                </div>
                                <div class="grid grid-cols-2 mt-1 gap-1 text-sm">
                                    <div class="flex items-center"><i class="fas fa-battery-full text-green-500 mr-2"></i><span>${drone.battery}</span></div>
                                    <div class="flex items-center"><i class="fas fa-clock text-gray-500 mr-2"></i><span>${drone.autonomy}</span></div>
                                    ${drone.capacity ? `<div class="flex items-center col-span-2"><i class="fas ${drone.name.includes('VTNT') ? 'fa-truck' : 'fa-fire-extinguisher'} text-blue-500 mr-2"></i><span>Carga: ${drone.capacity}</span></div>` : ''}
                                    <div class="flex items-center col-span-2">
                                        <i class="fas fa-wrench text-gray-500 mr-2"></i><span>Manutenção em: ${drone.maintenanceIn}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`
                ).join('');
            }
            // FIM DA MODIFICAÇÃO

            function renderDroneMarkers() {
                const mapContainer = document.getElementById('realTimeMap');
                mapContainer.querySelectorAll('.drone-marker').forEach(el => el.remove());
                
                drones
                    .filter(drone => drone.status === 'online')
                    .forEach(drone => {
                        const marker = document.createElement('div');
                        marker.className = 'drone-marker';
                        marker.style.left = drone.position.left;
                        marker.style.top = drone.position.top;
                        marker.innerHTML = `<div class="w-8 h-8 rounded-full ${drone.iconColor.replace('text-', 'bg-')} flex items-center justify-center border-2 border-white shadow-lg"><i class="fas ${drone.icon} text-white text-sm"></i></div>`;
                        mapContainer.appendChild(marker);
                    });
            }
            
            function updateTemperature() {
                let temp = parseFloat(currentTemperatureSpan.textContent) || 28;
                let change = Math.random() - 0.5;
                temp += change;
                currentTemperatureSpan.textContent = temp.toFixed(1);
            }
            setInterval(updateTemperature, 5000);

            function updateWindData() {
                const speed = (Math.random() * 25 + 5).toFixed(1);
                const directions = ['N', 'NE', 'L', 'SE', 'S', 'SO', 'O', 'NO'];
                const direction = directions[Math.floor(Math.random() * directions.length)];
                
                if (windSpeedSpan) {
                    windSpeedSpan.textContent = `${speed} km/h`;
                }
                if (windDirectionSpan) {
                    windDirectionSpan.textContent = direction;
                }
            }
            updateWindData();
            setInterval(updateWindData, 5000);

            function convertYoutubeUrlToEmbed(url) {
                if (!url) return "";
                let videoId = null;

                const standardUrlPattern = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(standardUrlPattern);
                if (match && match[1]) {
                    videoId = match[1];
                }

                if (videoId) {
                    return `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&controls=0&playlist=${videoId}`;
                }

                console.error("Não foi possível extrair o ID do vídeo da URL:", url);
                return "";
            }
            
            function renderVideo(containerId, videoUrl) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                if (videoUrl) {
                    const iframe = document.createElement('iframe');
                    iframe.src = videoUrl;
                    iframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture');
                    iframe.setAttribute('allowfullscreen', '');
                    container.appendChild(iframe);
                } else {
                    container.innerHTML = '<span class="text-white">Vídeo não configurado</span>';
                }
            }

            document.getElementById('configureVideosBtn').addEventListener('click', () => {
                document.getElementById('normalVideoUrl').value = towerVideos.normalVideo;
                document.getElementById('thermalVideoUrl').value = towerVideos.thermalVideo;
                configureVideosModal.classList.remove('hidden');
            });
            document.getElementById('cancelConfigureVideos').addEventListener('click', () => configureVideosModal.classList.add('hidden'));
            document.getElementById('saveConfiguredVideos').addEventListener('click', () => {
                 const normalUrl = document.getElementById('normalVideoUrl').value.trim();
                 const thermalUrl = document.getElementById('thermalVideoUrl').value.trim();
                 
                 towerVideos.normalVideo = normalUrl;
                 towerVideos.thermalVideo = thermalUrl;
                 
                 renderVideo('normalVideoContainer', convertYoutubeUrlToEmbed(normalUrl));
                 renderVideo('thermalVideoContainer', convertYoutubeUrlToEmbed(thermalUrl));
                 
                 configureVideosModal.classList.add('hidden');
            });

            const historyDatesList = document.getElementById('historyDatesList');
            renderHistoryDates();
            historyDatesList.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const date = e.target.dataset.date;
                    const data = historyEvents[date];
                    document.getElementById('historyModalTitle').textContent = `Eventos de ${date}`;
                    let contentHtml = `<h4 class="font-bold text-lg mb-2">Resumo do Dia</h4><p class="mb-6 pb-4 border-b">${data.summary}</p>`;
                    data.events.forEach((event, index) => {
                        contentHtml += `<div class="mb-4"><h5 class="font-semibold ${event.type === 'fire' ? 'text-danger' : 'text-secondary'} mb-2"><i class="fas ${event.type === 'fire' ? 'fa-fire' : 'fa-check-circle'} mr-2"></i>${event.type === 'fire' ? `Incêndio #${index + 1}`: `Atividade #${index + 1}`}</h5>`;
                        if (event.type === 'fire') {
                            contentHtml += `<ul class="list-disc list-inside text-gray-700 space-y-1"><li><strong>Local:</strong> ${event.location}</li><li><strong>Resposta:</strong> ${event.responseTime}</li><li><strong>Drones:</strong> ${event.dronesInvolved}</li><li><strong>Recursos:</strong> ${event.resourcesUsed}</li><li><strong>Duração:</strong> ${event.duration}</li></ul>`;
                        } else {
                            contentHtml += `<p class="text-gray-700">${event.report}</p>`;
                        }
                        contentHtml += `</div>`;
                    });
                    document.getElementById('historyModalContent').innerHTML = contentHtml;
                    historyModal.classList.remove('hidden');
                }
            });
            document.getElementById('closeHistoryModal').addEventListener('click', () => historyModal.classList.add('hidden'));
            function renderHistoryDates() {
                historyDatesList.innerHTML = Object.keys(historyEvents).map(date => `<button data-date="${date}" class="p-3 w-40 text-center ${historyEvents[date].events.some(e=>e.type === 'fire') ? 'bg-red-100 hover:bg-red-200 border-red-300' : 'bg-green-100 hover:bg-green-200 border-green-300'} border rounded-lg cursor-pointer transition">${date}</button>`).join('');
            }
            
            const userForm = document.getElementById('userForm');
            window.app = {
                editUser: (id) => openUserModal(users.find(u => u.id === id)),
                deleteUser: (id) => {
                    if (confirm('Tem certeza?')) {
                        users = users.filter(user => user.id !== id);
                        renderUsersTable();
                    }
                }
            };
            function renderUsersTable() {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = users.map(user => {
                    let roleClass, roleText;
                    switch (user.role) { case 'master': roleClass = 'bg-purple-100 text-purple-800'; roleText = 'Master'; break; case 'admin': roleClass = 'bg-blue-100 text-blue-800'; roleText = 'Admin'; break; default: roleClass = 'bg-green-100 text-green-800'; roleText = 'Visualizador'; }
                    return `<tr><td class="px-6 py-4"><div class="font-medium">${user.username}</div></td><td class="px-6 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleClass}">${roleText}</span></td><td class="px-6 py-4 text-right"><button onclick="app.editUser(${user.id})" class="text-secondary hover:text-primary mr-3"><i class="fas fa-edit"></i></button><button onclick="app.deleteUser(${user.id})" class="text-danger hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`;
                }).join('');
            }
            function openUserModal(user = null) {
                userForm.reset();
                document.getElementById('userId').value = user ? user.id : '';
                document.getElementById('modalTitle').textContent = user ? 'Editar Usuário' : 'Adicionar Usuário';
                if (user) {
                    document.getElementById('usernameInput').value = user.username;
                    document.getElementById('passwordInput').value = user.password;
                    document.getElementById('roleInput').value = user.role;
                }
                userModal.classList.remove('hidden');
            }
            function saveUser() {
                const id = document.getElementById('userId').value;
                const username = document.getElementById('usernameInput').value.trim();
                const password = document.getElementById('passwordInput').value.trim();
                const role = document.getElementById('roleInput').value;
                if (!username || !password) return alert('Preencha todos os campos.');
                if (id) { Object.assign(users.find(u => u.id == id), { username, password, role }); }
                else {
                    if (users.some(u => u.username === username)) return alert('Nome de usuário já existe.');
                    users.push({ id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1, username, password, role });
                }
                renderUsersTable();
                userModal.classList.add('hidden');
            }
            document.getElementById('addUserBtn').addEventListener('click', () => openUserModal());
            document.getElementById('saveUser').addEventListener('click', saveUser);
            document.getElementById('cancelModal').addEventListener('click', () => userModal.classList.add('hidden'));

        });
    </script>
</body>
</html>
